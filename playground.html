<html>
  <head>
    <script src="http://genie.site44.com/genie.js"> </script>
    <script src="http://genie.site44.com/jquery.js"> </script>
    <script src="http://genie.site44.com/base64.js"> </script>
    <script src="http://genie.site44.com/kapture.js"> </script>

    <style type='text/css'>
     * { padding:0px; margin:0px; }

     .parse_error {
       background-color: rgba(255, 0, 0, 0.1) !important;
     }

     textarea {
       border: 1px solid rgba(0,0,0,0.1);
       padding: 10px;
     }

     pre {
       white-space: pre-wrap;       /* CSS 3 */
       white-space: -moz-pre-wrap;  /* Mozilla, since 1999 */
       white-space: -pre-wrap;      /* Opera 4-6 */
       white-space: -o-pre-wrap;    /* Opera 7 */
       word-wrap: break-word;       /* Internet Explorer 5.5+ */
     }

     #data, #func {
       font-family: courier;
     }

     textarea:focus {
       background-color: rgba(0,0,255,0.05);
     }
    </style>
  </head>

  <body>
    <table width="100%" height="100%">
      <tr width="100%">
        <td width="30%" style='padding:10px;'>
          <textarea style='width:100%; height: 100%;' id='template'></textarea>
        </td>
        <td width="20%" style='padding:0px;'>
          <textarea style='width:100%; height: 50%;' id='data'></textarea>
          <textarea style='width:100%; height: 50%;' id='func'></textarea>
        </td>
        <td width="50%" style='padding:20px;' valign='top'>
          <div style='width:96%; height:90%; padding: 10px; margin-right:10px; border: 1px solid rgba(0,0,0,0.1); overflow:scroll;' id='render_target'>Rendering...</div>
          <input type='radio' name='render_type' id='use_html' CHECKED> Use HTML<br>
          <input type='radio' name='render_type' id='use_plain'> Use Plain Text<br>
          <input type='radio' name='render_type' id='use_html_pure'> Use Pure HTML<br>
        </td>
      </tr>
    </table>
  </body>
  
  <script type='text/javascript'>
   var last_error = null;
   var global_kap = new kapture.Kapture();
   
   global_kap.add_command('control-r', function() {
       attempt_update();
   });

   global_kap.add_command('tab', function() {
       var all_good = attempt_update();
       
       if (document.activeElement == $('#data')[0]) {
           $("#func").focus();
       } else if (document.activeElement == $('#template')[0]) {
           $("#data").focus();
       } else if (document.activeElement == $('#data')[0]) {
           $("#template").focus();
       } else {
           $("#template").focus();
       }
   });
   
   $(document).ready(function() {
       $(window).keydown(function(event) {
           global_kap.key_down(event);
       });

       $("#data").on('keyup', function() {
           attempt_update();
       });

       $("#template").on('keyup', function() {
           attempt_update();
       });

       $("#use_html").on('change', function() { attempt_update(); });
       $("#use_plain").on('change', function() { attempt_update(); });
       $("#use_html_pure").on('change', function() { attempt_update(); });
       setInterval(function() { attempt_update(); }, 500);

       loadup();
   });

   function loadup() {
       if (window.location.hash == "") {
           window.location.hash = 'VGhpcyBpcyBhIHRlbXBsYXRlLCBpdHMgbmFtZSBpcyBbWyB2Lm5hbWUgXV0uCgpUaGUgdmFsdWVzIG9mIHlvdXIgdGVtcGxhdGUgYXJlIHN0b3JlZCBpbiB0aGUgdXJsIGl0c2VsZiwgc28geW91IGNhbiBlYXNpbHkgc2hhcmUgeW91ciB3b3JrIHdpdGggb3RoZXJzIChqdXN0IGNvcHkgYW5kIHBhc3RlISkuCgpZb3UgY2FuIHVzZSB0aGUgYHRhYmAga2V5IHRvIHN3aXRjaCBxdWlja2x5IGJldHdlZW4gdGhlIHRlbXBsYXRlIGFuZCBkYXRhIGVkaXRvcnMuCgpZb3UgaGF2ZSAzIGRpZmZlcmVudCBlZGl0b3JzLCB0aGUgZmlyc3QgKHRoaXMgb25lKSBpcyB5b3VyIHRlbXBsYXRlIGRhdGEsIGFkZCBhbnkgdmFsaWQgR2VuaWUgdGVtcGxhdGUgaGVyZSBhbmQgaXQgd2lsbCBiZSByZW5kZXJlZCBpbiB0aGUgZGl2IHRvIHRoZSBmYXIgcmlnaHQuCgpJbiB0aGUgbWlkZGxlIHlvdSBoYXZlIHR3byBlZGl0b3JzLCB0aGUgdG9wIGlzIGZvciBKU09OIGRhdGEsIGFuZCB0aGUgYm90dG9tIGlzIGZvciBqYXZhc2NyaXB0IGNvZGUuIEFueSBrZXkgeW91IGNyZWF0ZSAobGlrZSAnbmFtZScpIHdpbGwgYmUgYXZhaWxhYmxlIGluIHlvdXIgdGVtcGxhdGUgd2l0aCB0aGUgbm9ybWFsIHYuKiBzeW50YXguICh5b3UgY2FuIHNlZSBob3cgYXQgdGhlIHRvcCBvZiB0aGlzIGRvYyB3aXRoIHYubmFtZSkuCgpUaGUgY29kZSBzZWN0aW9uIGlzIHJ1biBldmVyeSB0aW1lIHRoZSB0ZW1wbGF0ZSBpcyByZW5kZXJlZCAoeW91J2xsIG5vdGljZSB0aGUgdGltZSBpcyB1cGRhdGluZyBpbiB0aGUgY29udGVudCBiZWxvdykuIFlvdSdsbCBuZWVkIHRvIGFkZCBpdCB0byB0aGUgImV4cG9ydHMiIG9iamVjdCBpbiBvcmRlciB0byBoYXZlIGl0IGF2YWlsYWJsZSBpbiB5b3VyIHRlbXBsYXRlIChqdXN0IGxpa2UgTm9kZUpTKS4KClJlbWVtYmVyLCBoYXZlIGZ1biEKPGRpdiBzdHlsZT0ndGV4dC1hbGlnbjpjZW50ZXI7IGZvbnQtc2l6ZTogMjRweDsnPgogIFRoZSBjdXJyZW50IHRpbWUgaXMgPGJyPltbIHYudGltZSBdXQo8L2Rpdj4KCkFsc28sIHNpbmNlIHRoZSBkYXRhIGlzIHN0b3JlZCBpbiB0aGUgVVJMLCBpZiB5b3Ugd2FudCB0byBzYXZlIHRoZSBzdGF0ZSBvZiB0aGUgZWRpdG9yLCBqdXN0IGNvcHkgYW5kIHBhc3RlIHRoZSB1cmwgc29tZXdoZXJlLiA6KQoKPGRpdiBzdHlsZT0nY29sb3I6IGJsdWU7Jz5UaGUgaWQgaXMgW1sgdi5pZCBdXSBhbmQgdGhlIHN1bSBpcyBbWyB2LnN1bSBdXS48L2Rpdj4=:ewogICAgIm5hbWUiOiJHcmFoYW0iLAp9:dmFyIGlkID0gMTA7CgpleHBvcnRzLmlkID0gaWQ7Cgp2YXIgc3VtID0gMDsKCmZvcih2YXIgaT0wOyBpIDwgMTA7IGkrKykgewogICAgc3VtICs9IGk7Cn0KCmV4cG9ydHMuc3VtID0gc3VtOwoKZXhwb3J0cy50aW1lID0gZnVuY3Rpb24oKSB7CiAgcmV0dXJuIChuZXcgRGF0ZSgpKTsKfQ==:true';
       }
       
       var sp = window.location.hash.split(':');
       var template = Base64.decode(sp[0]);
       var data = Base64.decode(sp[1]);
       var func = Base64.decode(sp[2]);
       var render_type = sp[3];
       
       $("#template").val(template);
       $("#data").val(data);
       $("#func").val(func);
       
       if (render_type == 'true') {
           $("#use_html")[0].checked = true;
       } else if (render_type == 'use_html') {
           $("#use_html")[0].checked = true;
       } else if (render_type == 'use_plain') {
           $("#use_plain")[0].checked = true;
       } else if (render_type == 'use_html_pure') {
           $("#use_html_pure")[0].checked = true;
       }
       attempt_update();
   }

   function attempt_update() {
       var template_data = $("#template").val();
       var data_result = {};
       var func_result = {};
       
       try {
           data_result = eval("(function() { return " + $("#data").val() + "; })()");
           $("#data").removeClass("parse_error");
       } catch (e) {
           $("#data").addClass("parse_error");
       }

       try {
           func_result = eval("(function() { var exports = {}; " + $("#func").val() + "; return exports; })()");
           $("#func").removeClass("parse_error");
       } catch (e) {
           $("#func").addClass("parse_error");
       }

       var final_result = "<h1>Template Error</h1>";

       try {
           for(var key in func_result) {
               data_result[key] = func_result[key];
           }
           final_result = genie.fs(template_data, data_result);
           $("#template").removeClass("parse_error");
       } catch (e) {
           final_result = "" + e;
           last_error = e;
           $("#template").addClass("parse_error");
       }

       var render_type = $('input[name=render_type]:checked').attr('id');
       
       $("#render_target").html("");
       
       if (render_type == 'use_html') {
           final_result = final_result.replace(/\n/g, '<br \>');

           $("#render_target").html(final_result);
       } else if (render_type == 'use_plain') {
           var d = document.createElement('pre');
           d.innerText = final_result;
           $("#render_target").append(d);
       } else if (render_type == 'use_html_pure') {
           $("#render_target")[0].innerHTML = final_result;
       } else {
           //pass
       }
       generate_hash();
   }

   function generate_hash() {
       var template = Base64.encode($("#template").val());
       var data = Base64.encode($("#data").val());
       var func = Base64.encode($("#func").val());
       var render_type = $('input[name=render_type]:checked').attr('id');
       
       window.location.hash = template + ':' + data + ':' + func + ':' + render_type;
   }
  </script>
    
</html>

